<html th:replace="~{layout/baseTemplate :: html}" xmlns:th="http://www.thymeleaf.org">
<div th:fragment="contenido">
  <div class="d-flex p-4 gap-4">
    <div class="row">
      <div class="col-12 col-md-4 col-lg-3 col-xl-2">
        <div class="card custom-card p-0">
          <div class="card-header">
            <h4>Navegacion filtrada</h4>
          </div>
          <div class="card-body bg-success mb-3" style="--bs-bg-opacity: .5">
            <form th:action="@{/colecciones/{idColeccion}/hechos (idColeccion=${idColeccion}) }"
                  th:object="${filtros}"  method="get" onSubmit="validarInputs(event)">
              <div class="mb-3">
                <label class="form-label">Navegacion curada</label>
                <select th:field="*{curados}" class="form-select">
                  <option selected value="No">Seleccione una opcion</option>
                  <option value="Si">Si</option>
                  <option value="No">No</option>
                </select>
              </div>

              <div class="mb-3">
                <label for="categoria">Categoria</label>
                <input th:field="*{categoria}" id="categoria" type="text" class="form-control" placeholder="Filtrar por Categoria">
              </div>
              <div class="mb-3">
                <label for="provincia" class="form-label">Provincia</label>
                <input th:field="*{provincia}" id="provincia" type="text" class="form-control" placeholder="Filtrar por Provincia">
              </div>
              <div class="mb-3">
                <label for="municipio" class="form-label">Municipio</label>
                <input th:field="*{municipio}" id="municipio" type="text" class="form-control" placeholder="Filtrar por Municipio">
              </div>
              <div class="mb-3">
                <label for="departamento" class="form-label">Departamento</label>
                <input th:field="*{departamento}" id="departamento" type="text" class="form-control" placeholder="Filtrar por Departamento">
              </div>

              <div class="mb-3">
                <p>Inicio fecha de acontecimiento</p>
                <input id="fecha_inicio" th:field="*{fecha_acontecimiento_desde}" type="date" class="form-control" name="fecha_hecho_inicio">
              </div>
              <div class="mb-3">
                <p>Fin fecha acontecimiento</p>
                <input id="fecha_fin" th:field="*{fecha_acontecimiento_hasta}" type="date" class="form-control" name="fecha_hecho_fin">
              </div>
              <div class="errorMsg" hidden="true">

              </div>
              <button type="submit" class="btn btn-dark">Filtrar hechos</button>
            </form>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-8 col-lg-9 col-12 col-xl-10">
        <h1 th:text="${titulo}">Mapa de hechos</h1>
        <div>
          <div th:unless="${paginaActual==1}">
            <a th:href="@{/colecciones/{idColeccion}/hechos(idColeccion=${idColeccion}, page=${paginaActual-1},
             categoria=${filtros.categoria}, provincia=${filtros.provincia}, municipio=${filtros.municipio},
             departamento=${filtros.departamento}, curados=${filtros.curados},
             fecha_acontecimiento_desde=${filtros.fecha_acontecimiento_desde},
             fecha_acontecimiento_hasta=${filtros.fecha_acontecimiento_hasta})}"
               class="btn btn-outline-dark">Página anterior</a>
          </div>

          <span th:each="i : ${#numbers.sequence(1, paginasTotales)}">
        <a th:if="${i != paginaActual}"
           th:href="@{/colecciones/{idColeccion}/hechos(
                        idColeccion=${idColeccion},
                        page=${i},
                        categoria=${filtros.categoria},
                        provincia=${filtros.provincia},
                        municipio=${filtros.municipio},
                        departamento=${filtros.departamento},
                        curados=${filtros.curados},
                        fecha_acontecimiento_desde=${filtros.fecha_acontecimiento_desde},
                        fecha_acontecimiento_hasta=${filtros.fecha_acontecimiento_hasta})}"
           class="btn btn-outline-secondary" th:text="${i}">1</a>

        <span th:if="${i == paginaActual}" class="btn btn-dark" th:text="${i}">1</span>
    </span>

          <div th:unless="${paginaActual==paginasTotales}">
            <a th:href="@{/colecciones/{idColeccion}/hechos(idColeccion=${idColeccion}, page=${paginaActual+1},
             categoria=${filtros.categoria}, provincia=${filtros.provincia}, municipio=${filtros.municipio},
             departamento=${filtros.departamento}, curados=${filtros.curados},
             fecha_acontecimiento_desde=${filtros.fecha_acontecimiento_desde},
             fecha_acontecimiento_hasta=${filtros.fecha_acontecimiento_hasta})}"
               class="btn btn-outline-dark">Siguiente pagina</a>
          </div>
        </div>
        <div th:if="${hechos.empty}">
          <h4>Coleccion sin hechos</h4>
        </div>
        <div th:unless="${hechos.empty}">
          <main class="p-3 d-flex align-items-center justify-content-center">
            <div id="map" style="width: 90vw; height: 80vh"></div>
          </main>
        </div>
      </div>
    </div>
  </div>
  <script th:inline="javascript">
    /*<![CDATA[*/
        var hechos = /*[[${hechos}]]*/ []; // Thymeleaf convierte la lista en JSON
        console.log(hechos);
        var coleccionId = /*[[${idColeccion}]]*/;

        var map = L.map('map');

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        var markers = [];

        hechos.forEach(function(hecho) {
        if (hecho.latitud == null || hecho.longitud == null) {
           console.warn("Hecho con coordenadas inválidas:", hecho);
           return; // lo saltamos
           }
            var marker = L.marker([hecho.latitud, hecho.longitud]).addTo(map);
            console.log(hecho)
            marker.bindPopup(
                "<h4>Titulo: " + hecho.titulo + "</h4>" +
                "<h4>Categoria: " + hecho.categoria + "</h4>" +
                "<h4>Provincia" + hecho.provincia + "</h4>" +
                "<h4>Municipio: " + hecho.municipio + "</h4>" +
                "<h4>Departamento: " + hecho.departamento + "</h4>"
            );

            marker.on('mouseover', function() { this.openPopup(); });
            marker.on('mouseout', function() { this.closePopup(); });
            marker.on('click', function() { window.location.href = 'hechos/' + hecho.id; });

            markers.push(marker);
        });

        if (markers.length > 0) {
            var group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.2));
        } else {
            map.setView([-34.6037, -58.3816], 5);
        }
    /*]]>*/
  </script>
  <script src="/js/obtener-hechos.js"></script>
</div>
</html>
