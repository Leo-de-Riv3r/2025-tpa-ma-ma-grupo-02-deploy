<html th:replace="~{layout/baseTemplate :: html}" xmlns:th="http://www.thymeleaf.org">
<div th:fragment="contenido">
    <th:block th:fragment="css-extra">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
              integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
              crossorigin=""/>
    </th:block>

    <th:block th:fragment="js-extra">
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
                integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
                crossorigin=""></script>
    </th:block>
    <main class="p-3 container border border-solid">
        <h1>Solicitar modificacion</h1>
        <form class="d-flex flex-column row-gap-5" ,
              th:action="@{/procesarModificacionHecho}"
              th:object="${solicitud}"
              method="post">
            <div class="mb-3">
                <label for="titulo_coleccion" class="form-label">Titulo</label>
                <input id="titulo_coleccion" type="text" class="form-control" placeholder="Ingrese titulo" required
                       th:field="*{titulo}">
            </div>
            <div class="mb-3">
                <label class="form-label">Descripcion</label>
                <textarea class="form-control" placeholder="Ingrese descripcion de la coleccion" required
                          th:field="*{descripcion}"></textarea>
            </div>

            <div class="mb-3">
                <label class="form-label">Fecha acontecimiento</label>
                <input type="datetime-local" class="form-control" required th:field="*{fechaAcontecimiento}">
            </div>

            <div class="col-12 col-lg-8 col-md-8 mb-3">
                <label class="form-label">Ubicación (haz clic o arrastra el marcador)</label>

                <div id="map" style="height: 300px; width: 100%; border-radius: 5px; z-index: 1;"></div>

                <input type="hidden" id="latitud" class="form-control" th:field="*{latitud}" required step="any">
                <input type="hidden" id="longitud" class="form-control" th:field="*{longitud}" required step="any">
                <input type="hidden" id="categoria" class="form-control" th:field="*{categoria}" required step="any">
            </div>
            <input type="hidden" th:field="*{idHecho}" />
                <div class="mt-5">
                    <button id="submit-button" type="submit" class="btn btn-dark">Finalizar</button>
                </div>
        </form>

    </main>
    <script th:inline="javascript">
        /*<![CDATA[*/

        const initialLat = /*[[${solicitud.latitud ?: -34.6037}]]*/ -34.6037;
        const initialLon = /*[[${solicitud.longitud ?: -58.3816}]]*/ -58.3816;

        // Obtenemos los campos del formulario
        const latInput = document.getElementById('latitud');
        const lonInput = document.getElementById('longitud');

        // 1. Inicializar el mapa
        // Centramos el mapa en los valores iniciales, con un zoom de 13
        const map = L.map('map').setView([initialLat, initialLon], 13);

        // 2. Añadir la capa de "tiles" (la imagen del mapa)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // 3. Añadir un marcador inicial (que se puede arrastrar)
        let marker = L.marker([initialLat, initialLon], {
            draggable: true
        }).addTo(map);

        // Función para actualizar los inputs
        function updateInputs(latlng) {
            latInput.value = latlng.lat.toFixed(6); // 6 decimales de precisión
            lonInput.value = latlng.lng.toFixed(6);
        }

        // 4. Evento: Cuando el usuario termina de arrastrar el marcador
        marker.on('dragend', function(e) {
            updateInputs(marker.getLatLng());
        });

        // 5. Evento: Cuando el usuario hace clic en el mapa
        map.on('click', function(e) {
            const latlng = e.latlng;
            marker.setLatLng(latlng); // Mover el marcador al punto de clic
            updateInputs(latlng);
        });

        // Asegurarnos de que los inputs tengan los valores iniciales al cargar la página
        // (en caso de que el DTO ya los trajera, ej: error de validación)
        if (latInput.value && lonInput.value) {
            map.setView([latInput.value, lonInput.value], 13);
            marker.setLatLng([latInput.value, lonInput.value]);
        }

        /*]]>*/
    </script>
</div>

</html>